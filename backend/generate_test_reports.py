from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from reportlab.lib import colors
from reportlab.platypus import Table, TableStyle
import os

def create_report(filename, doc_type, risk_level, data, recommendations):
    c = canvas.Canvas(filename, pagesize=letter)
    width, height = letter
    
    # --- styles ---
    apollo_red = colors.HexColor("#b71c1c") # Dark red for Apollo
    
    # --- Header ---
    c.setFont("Helvetica-Bold", 18)
    c.setFillColor(apollo_red)
    c.drawCentredString(width/2, height - 50, "APOLLO MULTISPECIALITY HOSPITAL")
    
    c.setFont("Helvetica", 12)
    c.setFillColor(colors.black)
    sub_dept = "Department of Cardiology" if doc_type == "Heart" else "Department of Diabetology"
    c.drawCentredString(width/2, height - 70, sub_dept)
    
    # --- Patient Details Table ---
    y_pos = height - 120
    patient_data = [
        ["Patient Name", "Kumara Vishal"],
        ["Age / Sex", f"{data['age']} / {data.get('sex', 'Male')}"],
        ["Date", "06 Feb 2026"],
        ["Report Type", f"{doc_type} Risk Assessment"]
    ]
    
    table = Table(patient_data, colWidths=[150, 350])
    table.setStyle(TableStyle([
        ('GRID', (0,0), (-1,-1), 1, colors.black),
        ('FONTNAME', (0,0), (-1,-1), 'Helvetica'),
        ('FONTSIZE', (0,0), (-1,-1), 10),
        ('BACKGROUND', (0,0), (0,-1), colors.whitesmoke),
        ('PADDING', (0,0), (-1,-1), 6),
    ]))
    table.wrapOn(c, width, height)
    table.drawOn(c, 50, y_pos - 60)
    
    # --- Clinical Findings Header ---
    y_pos -= 90
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, y_pos, "Clinical Findings")
    
    # --- Clinical Findings Table ---
    y_pos -= 20
    # Add header to data
    table_data = [["Parameter", "Observed Value", "Clinical Interpretation"]] + data['metrics']
    
    col_widths = [180, 150, 170]
    t2 = Table(table_data, colWidths=col_widths)
    t2.setStyle(TableStyle([
        ('GRID', (0,0), (-1,-1), 1, colors.black),
        ('BACKGROUND', (0,0), (-1,0), colors.lightgrey),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (0,1), (-1,-1), 'Helvetica'),
        ('PADDING', (0,0), (-1,-1), 6),
    ]))
    t2.wrapOn(c, width, height)
    t_height = len(table_data) * 20 # approx height
    t2.drawOn(c, 50, y_pos - t_height) # simplified positioning
    
    y_pos -= (t_height + 40)
    
    # --- AI Assessment Summary ---
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, y_pos, "AI Assessment Summary")
    y_pos -= 20
    
    c.setFont("Helvetica-Bold", 11)
    c.drawString(50, y_pos, f"Prediction: {risk_level} Risk of {doc_type} Disease")
    c.drawString(50, y_pos - 15, f"Confidence: {data['confidence']}")
    
    y_pos -= 35
    c.setFont("Helvetica", 11)
    summary_text = "Based on clinical parameters and diagnostic indicators, the patient shows " 
    summary_text += "elevated" if risk_level == "High" else "moderate" if risk_level == "Moderate" else "normal"
    summary_text += f" cardiovascular / metabolic risk profile."
    c.drawString(50, y_pos, summary_text)
    
    # --- Medical Recommendations ---
    y_pos -= 40
    c.setFont("Helvetica-Bold", 12)
    c.drawString(50, y_pos, "Medical Recommendations")
    y_pos -= 20
    
    c.setFont("Helvetica", 11)
    for rec in recommendations:
        c.drawString(60, y_pos, f"- {rec}")
        y_pos -= 15

    # --- Footer ---
    c.setFont("Helvetica-Oblique", 9)
    c.drawCentredString(width/2, 40, "This report is generated by MedPro AI for preliminary screening purposes only.")
    
    c.save()
    print(f"Generated: {filename}")

def main():
    if not os.path.exists("test_reports"):
        os.makedirs("test_reports")
        
    # --- DIABETES PROFILES ---
    
    # Low Risk Diabetes
    data_dia_low = {
        "age": 35, "sex": "Male", "confidence": "High",
        "metrics": [
            ["Glucose", "90 mg/dL", "Normal"],
            ["Blood Pressure", "110/70 mmHg", "Optimal"],
            ["BMI", "22.5 kg/m2", "Normal Weight"],
            ["Insulin", "80 mu U/ml", "Normal"],
            ["Pregnancies", "0", "N/A"],
            ["Diabetes Pedigree", "0.20", "Low Genetic Risk"]
        ]
    }
    rec_dia_low = [
        "Maintain current healthy lifestyle",
        "Regular annual checkups",
        "Balanced diet and regular exercise"
    ]
    create_report("test_reports/Diabetes_Low_Risk.pdf", "Diabetes", "Low", data_dia_low, rec_dia_low)

    # Moderate Risk Diabetes (Adjusted to trigger > 40%)
    data_dia_mod = {
        "age": 50, "sex": "Male", "confidence": "Medium",
        "metrics": [
            ["Glucose", "148 mg/dL", "Impaired Fasting"],
            ["Blood Pressure", "135/85 mmHg", "High Normal"],
            ["BMI", "31.0 kg/m2", "Obese Class I"],
            ["Insulin", "175 mu U/ml", "Elevated"],
            ["Pregnancies", "0", "N/A"],
            ["Diabetes Pedigree", "0.75", "Moderate Genetic Risk"]
        ]
    }
    rec_dia_mod = [
        "Dietary modification (Low GI)",
        "Increase physical activity",
        "Follow-up glucose test in 3 months",
        "Weight management program"
    ]
    create_report("test_reports/Diabetes_Moderate_Risk.pdf", "Diabetes", "Moderate", data_dia_mod, rec_dia_mod)

    # High Risk Diabetes
    data_dia_high = {
        "age": 55, "sex": "Male", "confidence": "High",
        "metrics": [
            ["Glucose", "180 mg/dL", "High / Diabetic"],
            ["Blood Pressure", "150/95 mmHg", "Hypertension"],
            ["BMI", "34.0 kg/m2", "Obese"],
            ["Insulin", "200 mu U/ml", "High"],
            ["Pregnancies", "0", "N/A"],
            ["Diabetes Pedigree", "0.95", "High Genetic Risk"]
        ]
    }
    rec_dia_high = [
        "Immediate endocrinologist consultation",
        "Start prescribed medication",
        "Strict blood sugar monitoring",
        "Comprehensive lifestyle intervention"
    ]
    create_report("test_reports/Diabetes_High_Risk.pdf", "Diabetes", "High", data_dia_high, rec_dia_high)


    # --- HEART PROFILES ---

    # Low Risk Heart
    data_heart_low = {
        "age": 40, "sex": "Male", "confidence": "High",
        "metrics": [
            ["Chest Pain Type (cp)", "3 (Asymptomatic)", "Low Risk"],
            ["Resting BP (trestbps)", "115 mmHg", "Normal"],
            ["Cholesterol (chol)", "180 mg/dL", "Desirable"],
            ["Max Heart Rate (thalach)", "170 bpm", "Good"],
            ["ST Depression (oldpeak)", "0.0", "Normal"],
            ["Major Vessels (ca)", "0", "Clear"]
        ]
    }
    rec_heart_low = [
        "Routine cardiovascular screening every 5 years",
        "Maintain regular exercise routine",
        "Heart-healthy diet"
    ]
    create_report("test_reports/Heart_Low_Risk.pdf", "Heart", "Low", data_heart_low, rec_heart_low)

    # Moderate Risk Heart
    data_heart_mod = {
        "age": 52, "sex": "Male", "confidence": "Medium",
        "metrics": [
            ["Chest Pain Type (cp)", "2 (Non-anginal)", "Moderate Risk"],
            ["Resting BP (trestbps)", "135 mmHg", "Pre-hypertension"],
            ["Cholesterol (chol)", "230 mg/dL", "Borderline High"],
            ["Max Heart Rate (thalach)", "145 bpm", "Average"],
            ["ST Depression (oldpeak)", "1.2", "Mild Abnormality"],
            ["Major Vessels (ca)", "0", "Clear"],
            ["Thalassemia (thal)", "2 (Fixed Defect)", "Fixed Defect"]
        ]
    }
    rec_heart_mod = [
        "Cardiology consultation recommended",
        "Stress test evaluation",
        "Lipid profile monitoring",
        "Lifestyle modifications (Diet/Exercise)"
    ]
    create_report("test_reports/Heart_Moderate_Risk.pdf", "Heart", "Moderate", data_heart_mod, rec_heart_mod)

    # High Risk Heart
    data_heart_high = {
        "age": 63, "sex": "Male", "confidence": "High",
        "metrics": [
            ["Chest Pain Type (cp)", "0 (Typical Angina)", "High Risk"],
            ["Resting BP (trestbps)", "160 mmHg", "Hypertension Stage 2"],
            ["Cholesterol (chol)", "280 mg/dL", "High Risk"],
            ["Max Heart Rate (thalach)", "110 bpm", "Low Capacity"],
            ["ST Depression (oldpeak)", "3.5", "Severe Abnormality"],
            ["Major Vessels (ca)", "2", "Blockage Indicated"],
             ["Thalassemia (thal)", "3 (Reversible Defect)", "High Risk"]
        ]
    }
    rec_heart_high = [
        "URGENT: Immediate Cardiology Consultation",
        "Coronary Angiography recommended",
        "Begin medication regimen as prescribed",
        "Avoid strenuous activity until cleared"
    ]
    create_report("test_reports/Heart_High_Risk.pdf", "Heart", "High", data_heart_high, rec_heart_high)

if __name__ == "__main__":
    main()
